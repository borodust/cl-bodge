(cl:in-package :cl-bodge.graphics)


(declaim (special *shader-type*
                  *shader-dependencies*))


(defgeneric %header-of (shader)
  (:method (shader) (declare (ignore shader))))

(defgeneric %source-of (shader)
  (:method (shader) (declare (ignore shader))))

(defgeneric reload-shader-sources (shader))

(defgeneric %name-of (shader))

(defgeneric shader-descriptor-parameters (shader))

(defclass shader ()
  ((last-updated :initform 0 :reader shader-descriptor-last-updated)
   (header :reader %header-of)
   (source :reader %source-of)))


(defun %reload-shader-sources (shader header-paths source-paths)
  (with-slots (header source) shader
    (setf header (when header-paths
                   (format nil "窿磲疸狎＇蝈徜骈戾轭麸篝蜷铉桢徜弪疳翳螬┅箫躜沐麒孱箫躜沐疳翳ㄦ矧磲铋窿磲疸狎＇蝈徜骈戾轭麸篝蜷铉箫躜沐疳翳螬┅┅ㄤ彐礤翳镤轭轸獒扉瀛轭篝犷沐横骠弪è翳轶箬徜弪脲蝈祜徜箬徜弪箫躜沐翳轶┅ㄤ彐礤翳镤躔溽翦轭篝犷沐骘颦蝈溴骈铄洵沆狍横骠弪è翳轶箬徜弪徜溴洵箪雉溟筱狎溴洵箪雉痱镳弪豉扉篝蝈篝轭轸狎珞ㄤ邈灬蝈ㄩ珙矧徜溴洵箪雉溟筱狎溴洵箪雉痱镳弪豉扉篝轭轸狎珞┅鏖翳箪雉灬篝躔溽翦洎翳轶箦翩灬篝躔溽翦蝈犰糸礤箦泔钿螬蝈祜徜箬徜弪箫躜沐翳轶┅ㄤ彐躅屮疳钿狍滏忉箦疳翳ㄢ狍瀛疳翳啜礤蜱瀛疳翳钺礤蹰镳哄铙躜瀛溟蝈泗矧疳翳钺礤矧箦泔钿忉箦疳翳┅ㄡ箐婧泔眇镱孱舡疳翳钺礤ㄡ箐婧骈钿簌篝屙ㄦ轵篝忉箦疳翳┅┅ㄤ彐躅屮疳钿忉箦疳翳ㄢ狍瀛疳翳戾è篦轸汨ㄦ轵篝忉箦疳翳┅豉疱汜箦篦轸汨篝蜷铉篦轸汨簌礅镬ㄩㄥ后篝屙蝈灬糸鲥ㄦ轵篝忉箦疳翳┅ㄥ疳钿狍滏忉箦疳翳蝈篝忉箦疳翳┅篦轸汨┅篦轸汨┅┅ㄤ彐磲泸溴骟栳溴钺礤犷洵镳趔怙澌轭瘐舂ㄤ弩趄蹉趱蜷铉忾钿钺礤蝈篝镳趔ㄥ铙躜瀛扉篝钺礤犷洵镳趔ㄤ弩趄蹉趱蜷铉忾钿é脲桢徜弪箫躜沐è侯犴篝蜷铉殒殄洵钺礤扉篝趄犷箪狒瀛钺礤麸骘蝈殓钺礤┅ㄢ狍瀛疳翳扉篝ㄣ躜蝈铘骈戾趄蹂钺礤┅┅ㄡ扉篝痨轶镳趔鏖翳珏铙眢ē忉箦疳翳翳轶轭瘐舡扉篝ㄦ戾è泔祆邈舡疳翳疳翳モ狍瀛疳翳祜镳骘疳翳轭疳翳泔祆邈啜礤蜱瀛疳翳钺礤疳翳モ狍瀛疳翳┅┅啜痱镧ㄤ彐沆狍钺礤箬徜弪īㄤ彐礤翳镤ヮ犴瀛镦è翳轶钺礤┅荔趄轭玳骈邃钺礤戾è轭瘐舡扉篝扉篝括祜镳骘疳蜥礤翦轭轭瘐泔祆邈啜扉篝Кㄦ轵篝疳蜥礤翦颟括蝈篝疳蜥礤翦颟┅┅ㄤ彐礤翳镤箬徜弪溴筱蜷痿矧疳蜥礤翦蝮è翳轶钺礤┅轭瘐舡扉篝┅ㄤ彐礤翳镤蝈祜徜箬徜弪箫躜沐è翳轶钺礤┅戾èモ狍瀛疳翳蹰镳哄铙躜瀛溟蝈泗矧疳翳钺礤ㄥ疳钿忉箦疳翳忉箦疳翳┅┅ē蝈祜徜箬徜弪箫躜沐翳轶扉篝括泔祆邈舡疳翳桢徜弪モ狍瀛疳翳┅扉篝括泔祆邈舡疳翳箫躜沐モ狍瀛疳翳┅┅蝈玳篝弪箬徜弪扉怛狎К钺礤磲脲轭篝犷沐蟓镡箫戾翦К钺礤┅┅┅ㄤ彐躅痱镢弩蟓箬徜弪豉疱钺礤豉疱ㄥ汜箦豉疱ê鲥螋屮箬徜弪⒅乓耘剡尤聊乓ê翦篌屐灬糸镱泔铘蝻飙箬徜弪⒃庞优烫猎上芜孟卧蚁踢尤聊乓ê翦篌屐灬糸镱弼犰踽糸镱箬徜弪⒃庞优烫猎上芜胖撂樟陨衔哂攘呐尧ê珏镯弭蝙箬徜弪⑶畔团砸龠尤聊乓ê骝徵礤铘箬徜弪⑵伊峭盼赃尤聊乓ê泔眇豸瀛箬徜弪⒚贤姓耘哂攘呐尧┅ㄤ彐躅痱镢弩蟓鲥蝮轱瞽溟蝈泗轹ㄤ轵邈糸鲥秕麴豸ㄦ矧磲秕麴豸￣窿ィ溴骈铄雹溟蝈泗轹痱镢弩蟓箬徜弪豉疱钺礤箬徜弪豉疱┅ㄤ彐躅痱镢弩蟓轭沆蹁瀛溟蝈泗轹ㄤ轵邈糸鲥秕麴豸戾è篝狎痫箝糸镱＼溟蝈泗轹濠ㄥ钿痫箝糸镱＼溟蝈泗轹濠┅麒孱矧铛祆篝狎舂铛祆孱洎ㄥ蝌矧⑼犰骘蝽邃轭沆蹁搴В璃溟蝈泗轹濠戾舄è扉猸钺礤篚怏羼溟蝈泗轹ū篝狎舂孱洎扉怛狎ㄦ轭洵箬徜弪扉怛狎怡钺礤扉猸钺礤┅ㄤ弩泸轲麸箬徜弪扉怛狎溴筱蜷痿矧扉怛狎┅ㄨ遽溴ē桢徜弪镦溴筱蜷痿矧┅麒孱铛祆桢徜弪ㄥ蝌矧⑷遽溴骘扉怛狎璃铒骘躅洧扉猸钺礤┅瘐箬铄ㄣ灬篌钺礤镦溴筱蜷痿矧箬徜弪溴疱钿孱汩弩痱屦蝻沐篌箫躜沐桢徜弪秕麴豸ㄦ矧磲秕麴豸ア┅┅ㄤ彐躅痱镢弩蟓溟蝈泗轹ㄤ轵邈糸鲥秕麴豸篦轸汨ㄤ轵邈糸鲥呼弩灬礅溽ㄤ轵邈糸鲥痱彐轼篝狎趔鏖翳篚怏羼痱彐轼溟蝈泗轹濠┅á鲥蝮轱睥痱镢弩蟓鲥蝮轱瞽溟蝈泗轹溟蝈泗轹秕麴豸┅á轭沆蹁澧痱镢弩蟓轭沆蹁瀛溟蝈泗轹溟蝈泗轹秕麴豸┅ㄦ矧磲秕麴豸ィ立溟蝈泗轹濠┅ㄤ彐躅痱屦蝻沐篌箫躜沐箫躜沐秕麴豸ㄦ戾è趄轫篝蜷铉篝蜷铉篝蜷铉趄轫Ж＼羽徙＼葬猢篝蜷铉┅ㄤ镬轭弩扉铄箫躜沐ㄣ镱è篝狎趔鏖翳篚怏羼＂趄轫篝蜷铉扉铄┅痱镢弩蟓溟蝈泗轹趄轫篝蜷铉篚怏羼趄轫篝蜷铉扉铄暴秕麴豸┅ㄦ矧磲秕麴豸立扉铄┅┅┅ㄤ彐躅痱屦蝻沐篌箬徜弪箬徜弪豉疱戾è箬徜弪豉疱豉疱í箬徜弪溴疱钿孱汩弩铋飑箫躜沐ē箫躜沐镦箬徜弪┅鲠祯弩鏖翳秕麴豸麸篝蜷铉秕麴豸痱屦蝻沐篌箫躜沐箫躜沐秕麴豸┅ㄤ屐弭彐箬徜弪溴疱钿孱汩弩ㄣ灬篌钺礤镦箬徜弪┅┅